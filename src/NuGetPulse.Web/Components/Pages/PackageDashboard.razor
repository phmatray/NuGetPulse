@page "/package/{PackageId}"
@rendermode InteractiveServer
@using NuGetPulse.Core.Abstractions
@using NuGetPulse.Core.Models
@using NuGetPulse.Web.Models
@using NuGetPulse.Web.Services
@inject NuGetService NuGetService
@inject IVulnerabilityScanner VulnerabilityScanner

<PageTitle>@PackageId ‚Äî NuGetPulse</PageTitle>

@if (_loading)
{
    <div class="loading-screen">
        <div class="spinner-large"></div>
        <p>Loading <strong>@PackageId</strong>‚Ä¶</p>
    </div>
}
else if (_error is not null)
{
    <div class="error-screen">
        <p class="error-icon">üòï</p>
        <h2>Package not found</h2>
        <p>@_error</p>
        <a href="/" class="btn-home">‚Üê Back to search</a>
    </div>
}
else if (_stats is not null)
{
    <div class="dashboard">
        <!-- Header -->
        <div class="dash-header">
            <div class="dash-header-left">
                @if (!string.IsNullOrEmpty(_stats.IconUrl))
                {
                    <img src="@_stats.IconUrl" class="dash-icon" alt="@_stats.Id" onerror="this.style.display='none'" />
                }
                else
                {
                    <div class="dash-icon-placeholder">üì¶</div>
                }
                <div>
                    <h1 class="dash-title">@_stats.Id</h1>
                    <div class="dash-meta">
                        <span class="badge bg-secondary">v@_stats.Version</span>
                        @if (_stats.IsVerified)
                        {
                            <span class="badge bg-info text-dark">‚úì Verified</span>
                        }
                        <span class="@_healthBadgeClass">@_healthLabel</span>
                        @if (!string.IsNullOrEmpty(_stats.LicenseExpression))
                        {
                            <span class="badge bg-light text-dark border">@_stats.LicenseExpression</span>
                        }
                    </div>
                </div>
            </div>
            <div class="dash-header-right">
                <div class="stat-pill">
                    <span class="stat-label">Total Downloads</span>
                    <span class="stat-value">@_stats.FormattedDownloads</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Versions</span>
                    <span class="stat-value">@_stats.Versions.Count</span>
                </div>
                @if (_stats.Published.HasValue)
                {
                    <div class="stat-pill">
                        <span class="stat-label">Last Published</span>
                        <span class="stat-value">@_stats.Published.Value.ToString("MMM d, yyyy")</span>
                    </div>
                }
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_stats.Description))
        {
            <p class="dash-description">@_stats.Description</p>
        }

        @if (!string.IsNullOrEmpty(_stats.Authors))
        {
            <p class="dash-authors">by <strong>@_stats.Authors</strong></p>
        }

        <div class="dash-links">
            <a href="https://www.nuget.org/packages/@_stats.Id" target="_blank" class="dash-link">nuget.org ‚Üí</a>
            @if (!string.IsNullOrEmpty(_stats.ProjectUrl))
            {
                <a href="@_stats.ProjectUrl" target="_blank" class="dash-link">Project ‚Üí</a>
            }
        </div>

        <!-- Health Score (backed by real OSV vulnerability data) -->
        <div class="card-panel">
            <h2 class="panel-title">Health Score</h2>
            <div class="health-row">
                <span class="health-score-big">@_computedHealth.Score<span class="health-score-unit">/100</span></span>
                <div class="health-bar-wrap">
                    <div class="health-bar">
                        <div class="health-bar-fill @_healthBarClass" style="width: @_computedHealth.Score%"></div>
                    </div>
                    <span class="health-label-text">@_healthLabel</span>
                </div>
            </div>
            <div class="health-criteria">
                <div class="criterion">
                    <span>üì• Downloads</span>
                    <span class="criterion-value">@_stats.FormattedDownloads</span>
                </div>
                <div class="criterion">
                    <span>üî¢ Versions</span>
                    <span class="criterion-value">@_stats.Versions.Count</span>
                </div>
                <div class="criterion">
                    <span>üìÖ Last Release</span>
                    <span class="criterion-value">@(_stats.Published?.ToString("MMM yyyy") ?? "‚Äî")</span>
                </div>
                <div class="criterion">
                    <span>üîó Project Link</span>
                    <span class="criterion-value">@(string.IsNullOrEmpty(_stats.ProjectUrl) ? "‚ùå" : "‚úÖ")</span>
                </div>
                <div class="criterion">
                    <span>‚öñÔ∏è License</span>
                    <span class="criterion-value">@(string.IsNullOrEmpty(_stats.LicenseExpression) ? "‚ùå" : _stats.LicenseExpression)</span>
                </div>
                <!-- Real vulnerability count from OSV API -->
                <div class="criterion">
                    <span>üõ°Ô∏è Vulnerabilities</span>
                    <span class="criterion-value @(_vulnReport?.HasVulnerabilities == true ? "text-danger fw-bold" : "text-success")">
                        @if (_vulnScanLoading)
                        {
                            <span class="spinner-sm">‚è≥</span>
                        }
                        else if (_vulnReport is null)
                        {
                            <span>‚Äî</span>
                        }
                        else if (_vulnReport.HasVulnerabilities)
                        {
                            <span>‚ö†Ô∏è @_vulnReport.Count found</span>
                        }
                        else
                        {
                            <span>‚úÖ None</span>
                        }
                    </span>
                </div>
            </div>
        </div>

        <!-- Vulnerability details (if any found) -->
        @if (_vulnReport?.HasVulnerabilities == true)
        {
            <div class="card-panel border-danger">
                <h2 class="panel-title text-danger">‚ö†Ô∏è Security Vulnerabilities (@_vulnReport.Count)</h2>
                <div class="vuln-list">
                    @foreach (var vuln in _vulnReport.Vulnerabilities)
                    {
                        <div class="vuln-item">
                            <div class="vuln-header">
                                <span class="vuln-id">@vuln.Id</span>
                                <span class="badge @GetSeverityBadge(vuln.Severity)">@vuln.Severity</span>
                            </div>
                            <p class="vuln-summary">@vuln.Summary</p>
                            @if (!string.IsNullOrEmpty(vuln.ReferenceUrl))
                            {
                                <a href="@vuln.ReferenceUrl" target="_blank" class="vuln-link">More info ‚Üí</a>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Version download chart -->
        @if (_stats.Versions.Count > 0)
        {
            <div class="card-panel">
                <h2 class="panel-title">Version Adoption (top 10)</h2>
                <div class="version-chart">
                    @foreach (var v in _stats.Versions.OrderByDescending(v => v.Downloads).Take(10))
                    {
                        <div class="version-row">
                            <span class="version-label">@v.Version</span>
                            <div class="version-bar-track">
                                <div class="version-bar-fill" style="width: @v.BarWidthPercent%"></div>
                            </div>
                            <span class="version-dl">@v.FormattedDownloads</span>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Target frameworks -->
        @if (_stats.TargetFrameworks.Count > 0)
        {
            <div class="card-panel">
                <h2 class="panel-title">Target Frameworks</h2>
                <div class="framework-chips">
                    @foreach (var tfm in _stats.TargetFrameworks)
                    {
                        <span class="tfm-chip @GetTfmClass(tfm)">@tfm</span>
                    }
                </div>
            </div>
        }

        <!-- Tags -->
        @if (_stats.Tags.Count > 0)
        {
            <div class="card-panel">
                <h2 class="panel-title">Tags</h2>
                <div class="tags-wrap">
                    @foreach (var tag in _stats.Tags.Take(20))
                    {
                        <span class="tag-chip">@tag</span>
                    }
                </div>
            </div>
        }

        <div class="back-link-wrap">
            <a href="/" class="btn-home">‚Üê Back to search</a>
        </div>
    </div>
}

@code {
    [Parameter] public string PackageId { get; set; } = string.Empty;

    private PackageStats? _stats;
    private bool _loading = true;
    private string? _error;

    // Vulnerability state (loaded asynchronously after stats)
    private VulnerabilityReport? _vulnReport;
    private bool _vulnScanLoading = false;

    // Computed health from HealthScore model (using real vuln data)
    private HealthScore _computedHealth = new();

    private string _healthLabel => _computedHealth.Status switch
    {
        HealthStatus.Healthy  => "Excellent",
        HealthStatus.Warning  => "Good",
        HealthStatus.Critical => "Needs Attention",
        _ => "Unknown"
    };

    private string _healthBadgeClass => _computedHealth.Status switch
    {
        HealthStatus.Healthy  => "badge bg-success",
        HealthStatus.Warning  => "badge bg-primary",
        HealthStatus.Critical => "badge bg-danger",
        _ => "badge bg-secondary"
    };

    private string _healthBarClass => _computedHealth.Status switch
    {
        HealthStatus.Healthy  => "bg-success",
        HealthStatus.Warning  => "bg-primary",
        HealthStatus.Critical => "bg-danger",
        _ => "bg-secondary"
    };

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;
        _stats = null;
        _vulnReport = null;

        try
        {
            _stats = await NuGetService.GetPackageStatsAsync(PackageId);
            if (_stats is null)
            {
                _error = $"Could not find package '{PackageId}' on NuGet.org.";
                return;
            }

            // Compute initial health with 0 vulns (updated when OSV scan completes)
            _computedHealth = HealthScore.Compute(
                _stats.TotalDownloads,
                _stats.Published,
                vulnerabilityCount: 0,
                isDeprecated: false);
        }
        catch (Exception ex)
        {
            _error = $"Failed to load package data: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }

        // Kick off OSV vulnerability scan in the background (non-blocking)
        if (_stats is not null)
            _ = ScanVulnerabilitiesAsync();
    }

    private async Task ScanVulnerabilitiesAsync()
    {
        _vulnScanLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            _vulnReport = await VulnerabilityScanner.ScanAsync(PackageId, _stats!.Version);

            // Recompute health with real vulnerability count
            _computedHealth = HealthScore.Compute(
                _stats.TotalDownloads,
                _stats.Published,
                vulnerabilityCount: _vulnReport.Count,
                isDeprecated: false);
        }
        catch
        {
            // Vulnerability scan is best-effort; don't fail the page
            _vulnReport = null;
        }
        finally
        {
            _vulnScanLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string GetTfmClass(string tfm) => tfm switch
    {
        var t when t.StartsWith("net10")       => "tfm-net10",
        var t when t.StartsWith("net9")        => "tfm-net9",
        var t when t.StartsWith("net8")        => "tfm-net8",
        var t when t.StartsWith("net7")        => "tfm-net7",
        var t when t.StartsWith("netstandard") => "tfm-std",
        var t when t.StartsWith("netcoreapp")  => "tfm-core",
        _ => "tfm-legacy"
    };

    private static string GetSeverityBadge(OsvSeverity severity) => severity switch
    {
        OsvSeverity.Critical => "bg-danger",
        OsvSeverity.High     => "bg-danger",
        OsvSeverity.Medium   => "bg-warning text-dark",
        OsvSeverity.Low      => "bg-info text-dark",
        _ => "bg-secondary"
    };
}
