@page "/scan"
@rendermode InteractiveServer
@using NuGetPulse.Core.Abstractions
@using NuGetPulse.Core.Models
@using NuGetPulse.Export
@using NuGetPulse.Export.Models
@using NuGetPulse.Graph
@using NuGetPulse.Graph.Models
@using NuGetPulse.Persistence
@inject IPackageScanner PackageScanner
@inject IVulnerabilityScanner VulnerabilityScanner
@inject IPackageExportService ExportService
@inject IDependencyGraphBuilder GraphBuilder
@inject IScanHistoryRepository ScanHistory
@inject IJSRuntime JS

<PageTitle>Scan ‚Äî NuGetPulse</PageTitle>

<div class="dashboard">
    <div class="dash-header">
        <div class="dash-header-left">
            <div class="dash-icon-placeholder">üîç</div>
            <div>
                <h1 class="dash-title">Scan Projects</h1>
                <p class="dash-authors">Discover NuGet packages, conflicts, and vulnerabilities in your solution</p>
            </div>
        </div>
    </div>

    <!-- Scan form -->
    <div class="card-panel">
        <h2 class="panel-title">Scan a Directory</h2>
        <div class="scan-form">
            <div class="scan-input-row">
                <label for="scan-name">Name</label>
                <input id="scan-name"
                       type="text"
                       placeholder="My Solution"
                       @bind="_scanName"
                       class="form-control" />
            </div>
            <div class="scan-input-row">
                <label for="scan-path">Directory Path</label>
                <input id="scan-path"
                       type="text"
                       placeholder="/path/to/your/solution"
                       @bind="_scanPath"
                       class="form-control" />
            </div>
            <div class="scan-actions">
                <button class="btn btn-primary"
                        @onclick="RunScanAsync"
                        disabled="@(_scanning || string.IsNullOrWhiteSpace(_scanPath))">
                    @if (_scanning)
                    {
                        <span>‚è≥ @_scanPhase‚Ä¶</span>
                    }
                    else
                    {
                        <span>üîç Start Scan</span>
                    }
                </button>
            </div>
            @if (_scanError is not null)
            {
                <div class="alert alert-danger mt-2">@_scanError</div>
            }
        </div>
    </div>

    <!-- Scan results -->
    @if (_packages is not null && _packages.Count > 0)
    {
        <!-- Summary stats row -->
        <div class="card-panel">
            <div class="panel-title-row">
                <h2 class="panel-title">üìä Scan Summary</h2>
                <div class="export-actions">
                    <button class="btn btn-sm btn-outline-success" @onclick="() => DownloadAsync(ExportFormat.Csv)">
                        üìä Export CSV
                    </button>
                    <button class="btn btn-sm btn-outline-info" @onclick="() => DownloadAsync(ExportFormat.Json)">
                        { } Export JSON
                    </button>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-tile">
                    <span class="summary-value">@_packages.Count</span>
                    <span class="summary-label">Packages</span>
                </div>
                <div class="summary-tile @(_graph?.ConflictCount > 0 ? "tile-warning" : "")">
                    <span class="summary-value">@(_graph?.ConflictCount ?? 0)</span>
                    <span class="summary-label">Conflicts</span>
                </div>
                <div class="summary-tile @(_totalVulnerabilities > 0 ? "tile-danger" : "tile-ok")">
                    @if (_vulnScanLoading)
                    {
                        <span class="summary-value"><span class="spinner-sm"></span></span>
                    }
                    else
                    {
                        <span class="summary-value">@_totalVulnerabilities</span>
                    }
                    <span class="summary-label">Vulnerabilities</span>
                </div>
                <div class="summary-tile">
                    <span class="summary-value @GetHealthScoreClass(_scanHealthScore)">@(_scanHealthScore > 0 ? _scanHealthScore : "‚Äî")</span>
                    <span class="summary-label">Health Score</span>
                </div>
            </div>

            @if (_vulnScanLoading)
            {
                <div class="alert alert-info mt-3 d-flex align-items-center gap-2">
                    <span class="spinner-sm"></span>
                    <span>Running OSV vulnerability scan for @_packages.Select(p => $"{p.PackageName}@{p.Version}").Distinct().Count() unique packages‚Ä¶</span>
                </div>
            }
        </div>

        <!-- Conflict alert -->
        @if (_graph?.ConflictCount > 0)
        {
            <div class="alert alert-warning">
                ‚ö†Ô∏è <strong>@_graph.ConflictCount version conflict(s) detected.</strong>
                Packages with multiple versions across project files are highlighted below.
            </div>
        }

        <!-- Vulnerability alert -->
        @if (_totalVulnerabilities > 0 && !_vulnScanLoading)
        {
            <div class="alert alert-danger">
                üî¥ <strong>@_totalVulnerabilities vulnerability(-ies) found</strong> across @_vulnerabilities.Count(kv => kv.Value.HasVulnerabilities) package(s).
                Review the security section below.
            </div>
        }

        <!-- Package table -->
        <div class="card-panel">
            <h2 class="panel-title">Packages (@_packages.Count)</h2>
            <div class="package-table-wrap">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Package</th>
                            <th>Version</th>
                            <th>Project</th>
                            <th>Type</th>
                            <th>CPM</th>
                            <th>Security</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pkg in _packages.OrderBy(p => p.PackageName))
                        {
                            var hasConflict = _graph?.Conflicts.ContainsKey(pkg.PackageName) == true;
                            var vulnKey = $"{pkg.PackageName}@@{pkg.Version}";
                            _vulnerabilities.TryGetValue(vulnKey, out var vulnReport);
                            var rowClass = hasConflict ? "table-warning" : (vulnReport?.HasVulnerabilities == true ? "table-danger" : "");
                            <tr class="@rowClass">
                                <td>
                                    <a href="/package/@pkg.PackageName">@pkg.PackageName</a>
                                    @if (hasConflict)
                                    {
                                        <span class="badge bg-warning text-dark ms-1">conflict</span>
                                    }
                                </td>
                                <td><code>@pkg.Version</code></td>
                                <td class="text-muted small">@Path.GetFileName(pkg.ProjectFile)</td>
                                <td class="text-muted small">@pkg.Type</td>
                                <td>@(pkg.IsCentrallyManaged ? "‚úÖ" : "")</td>
                                <td>
                                    @if (_vulnScanLoading && vulnReport is null)
                                    {
                                        <span class="text-muted small">‚Ä¶</span>
                                    }
                                    else if (vulnReport is null)
                                    {
                                        <span class="text-muted small">‚Äî</span>
                                    }
                                    else if (!vulnReport.HasVulnerabilities)
                                    {
                                        <span class="badge bg-success">‚úì Safe</span>
                                    }
                                    else
                                    {
                                        @foreach (var severityGroup in vulnReport.Vulnerabilities.GroupBy(v => v.Severity).OrderByDescending(g => (int)g.Key))
                                        {
                                            <span class="badge @GetSeverityBadge(severityGroup.Key) me-1">@severityGroup.Key @severityGroup.Count()</span>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Conflict details -->
        @if (_graph?.ConflictCount > 0)
        {
            <div class="card-panel">
                <h2 class="panel-title">‚ö†Ô∏è Version Conflicts</h2>
                @foreach (var (name, conflict) in _graph.Conflicts)
                {
                    <div class="conflict-item">
                        <strong>@name</strong>
                        <span class="badge @GetConflictBadge(conflict.Severity)">@conflict.SeverityLabel severity</span>
                        <span class="text-muted ms-2">Versions: @string.Join(", ", conflict.Versions)</span>
                        @if (conflict.SuggestedVersion is not null)
                        {
                            <span class="text-success ms-2">‚Üí Suggested: @conflict.SuggestedVersion</span>
                        }
                    </div>
                }
            </div>
        }

        <!-- Vulnerability details -->
        @if (_totalVulnerabilities > 0 && !_vulnScanLoading)
        {
            <div class="card-panel">
                <h2 class="panel-title text-danger">üî¥ Security Vulnerabilities (@_totalVulnerabilities)</h2>
                @foreach (var (key, report) in _vulnerabilities.Where(kv => kv.Value.HasVulnerabilities))
                {
                    <div class="vuln-package-block">
                        <h3 class="vuln-package-name">
                            <a href="/package/@report.PackageId">@report.PackageId</a>
                            <code class="ms-2">@report.Version</code>
                        </h3>
                        @foreach (var vuln in report.Vulnerabilities)
                        {
                            <div class="vuln-item">
                                <div class="vuln-header">
                                    <span class="badge @GetSeverityBadge(vuln.Severity)">@vuln.Severity</span>
                                    <strong class="ms-2">@vuln.Id</strong>
                                    @if (!string.IsNullOrEmpty(vuln.Summary))
                                    {
                                        <span class="ms-2 text-muted">@vuln.Summary</span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(vuln.Details))
                                {
                                    <p class="vuln-details text-muted small">@vuln.Details[..Math.Min(vuln.Details.Length, 200)]@(vuln.Details.Length > 200 ? "‚Ä¶" : "")</p>
                                }
                                <div class="vuln-meta">
                                    @if (vuln.Aliases.Count > 0)
                                    {
                                        <span class="badge bg-secondary me-1">@string.Join(", ", vuln.Aliases.Take(3))</span>
                                    }
                                    @if (!string.IsNullOrEmpty(vuln.ReferenceUrl))
                                    {
                                        <a href="@vuln.ReferenceUrl" target="_blank" class="small">Details ‚Üí</a>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
    else if (_packages is not null && _packages.Count == 0)
    {
        <div class="card-panel">
            <p>No packages found in <code>@_scanPath</code>.</p>
        </div>
    }

    <!-- Scan history -->
    @if (_recentScans.Count > 0)
    {
        <div class="card-panel">
            <div class="panel-title-row">
                <h2 class="panel-title">Recent Scans</h2>
                <a href="/history" class="btn btn-sm btn-outline-secondary">View all ‚Üí</a>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Path</th>
                        <th>Packages</th>
                        <th>Vulns</th>
                        <th>Scanned</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var session in _recentScans)
                    {
                        <tr>
                            <td>@session.Name</td>
                            <td class="text-muted small">@session.Path</td>
                            <td>@session.PackageCount</td>
                            <td class="@(session.VulnerabilityCount > 0 ? "text-danger fw-bold" : "text-success")">
                                @(session.VulnerabilityCount > 0 ? $"‚ö†Ô∏è {session.VulnerabilityCount}" : "‚úì")
                            </td>
                            <td class="text-muted small">@session.ScannedAt.ToString("MMM d, HH:mm")</td>
                            <td class="text-muted small">@session.DurationMs ms</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <div class="back-link-wrap">
        <a href="/" class="btn-home">‚Üê Back to search</a>
    </div>
</div>

@code {
    private string _scanName = string.Empty;
    private string _scanPath = string.Empty;
    private bool _scanning = false;
    private string _scanPhase = "Scanning";
    private string? _scanError = null;
    private IReadOnlyList<PackageReference>? _packages = null;
    private DependencyGraph? _graph = null;
    private List<NuGetPulse.Persistence.Entities.ScanSession> _recentScans = [];

    // OSV state (updated async after scan)
    private Dictionary<string, VulnerabilityReport> _vulnerabilities = new();
    private bool _vulnScanLoading = false;
    private int _totalVulnerabilities = 0;
    private int _scanHealthScore = 0;

    protected override async Task OnInitializedAsync()
    {
        _recentScans = (await ScanHistory.GetRecentSessionsAsync(5)).ToList();
    }

    private async Task RunScanAsync()
    {
        _scanning = true;
        _scanPhase = "Scanning";
        _scanError = null;
        _packages = null;
        _graph = null;
        _vulnerabilities = new();
        _vulnScanLoading = false;
        _totalVulnerabilities = 0;
        _scanHealthScore = 0;
        StateHasChanged();

        var sw = System.Diagnostics.Stopwatch.StartNew();
        try
        {
            _packages = await PackageScanner.ScanDirectoryAsync(_scanPath.Trim());
            sw.Stop();

            // Build graph for conflict detection
            _graph = GraphBuilder.Build(_packages);

            // Persist scan (vuln count = 0 initially, updated after OSV scan)
            var name = string.IsNullOrWhiteSpace(_scanName) ? Path.GetFileName(_scanPath.TrimEnd('/', '\\')) : _scanName;
            await ScanHistory.SaveScanAsync(name, _scanPath.Trim(), _packages, sw.ElapsedMilliseconds, 0);

            // Refresh history
            _recentScans = (await ScanHistory.GetRecentSessionsAsync(5)).ToList();
        }
        catch (Exception ex)
        {
            _scanError = $"Scan failed: {ex.Message}";
            _scanning = false;
            return;
        }
        finally
        {
            _scanning = false;
        }

        // Kick off OSV scan (non-blocking, updates state incrementally)
        if (_packages is not null && _packages.Count > 0)
            _ = RunVulnerabilityScanAsync();
    }

    private async Task RunVulnerabilityScanAsync()
    {
        if (_packages is null) return;

        _vulnScanLoading = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Distinct (packageId, version) pairs to avoid duplicate OSV queries
            var distinct = _packages
                .GroupBy(p => $"{p.PackageName}@@{p.Version}", StringComparer.OrdinalIgnoreCase)
                .Select(g => (g.First().PackageName, g.First().Version))
                .ToList();

            var reports = await VulnerabilityScanner.ScanBatchAsync(distinct);

            foreach (var report in reports)
            {
                var key = $"{report.PackageId}@@{report.Version}";
                _vulnerabilities[key] = report;
            }

            _totalVulnerabilities = _vulnerabilities.Values.Sum(r => r.Count);

            // Compute scan-level health score
            // Start at 100, deduct for conflicts and vulnerabilities
            var conflictPenalty = (_graph?.ConflictCount ?? 0) * 5;
            var vulnPenalty = _totalVulnerabilities switch
            {
                0 => 0,
                1 => 10,
                <= 3 => 20,
                <= 5 => 35,
                _ => 50
            };
            _scanHealthScore = Math.Max(0, 100 - conflictPenalty - vulnPenalty);
        }
        catch
        {
            // OSV scan is best-effort; don't fail the page
        }
        finally
        {
            _vulnScanLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DownloadAsync(ExportFormat format)
    {
        if (_packages is null) return;
        var name = string.IsNullOrWhiteSpace(_scanName) ? "packages" : _scanName;

        ExportResult result;
        if (format == ExportFormat.Csv)
            result = await ExportService.ExportToCsvAsync(_packages, name);
        else
            result = await ExportService.ExportToJsonAsync(_packages);

        // Trigger browser download via JS interop
        await JS.InvokeVoidAsync("downloadFile", result.FileName, result.MimeType, result.BinaryData);
    }

    private static string GetConflictBadge(int severity) => severity switch
    {
        3 => "bg-danger",
        2 => "bg-warning text-dark",
        _ => "bg-info text-dark"
    };

    private static string GetSeverityBadge(OsvSeverity severity) => severity switch
    {
        OsvSeverity.Critical => "bg-danger",
        OsvSeverity.High     => "bg-danger",
        OsvSeverity.Medium   => "bg-warning text-dark",
        OsvSeverity.Low      => "bg-info text-dark",
        _ => "bg-secondary"
    };

    private static string GetHealthScoreClass(int score) => score switch
    {
        >= 80 => "text-success",
        >= 60 => "text-warning",
        > 0   => "text-danger",
        _     => ""
    };
}
